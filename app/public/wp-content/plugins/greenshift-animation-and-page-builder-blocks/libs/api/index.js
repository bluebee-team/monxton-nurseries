const GS_SESSION_ID="uid-"+Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,11);function GSrunAPICall(e){if("string"==typeof e&&(e=JSON.parse(e)),!e)return;function t(e,t){if(!t)return e;let r=t.match(/(\w+)|\[(\d+)\]/g);if(r)return r.reduce((e,t)=>(t=t.replace(/[\[\]]/g,""),e?e[t]:void 0),e)}let r=[{regex:/\{\{TEXT:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);return t&&t.innerText?t.innerText:""}},{regex:/\{\{VALUE:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);return t&&t.value?t.value:""}},{regex:/\{\{COOKIE:(.*?)\}\}/g,handler(e){let t;return GSCookClass.getCookie(e)||""}},{regex:/\{\{STORAGE:(.*?)\}\}/g,handler(e){let t;return localStorage.getItem(e)||""}},{regex:/\{\{ATTR:(.*?)\}\}/g,handler(e){let t=e.split("|").map(e=>e.trim());if(2===t.length){let r=t[0],a=document.querySelector(t[1]);return a&&a.getAttribute(r)||""}return""}},{regex:/\{\{FORMDATA:(.*?)\}\}/g,handler(e){let t=document.querySelector(e);if(t){let r=new FormData(t),a={};return r.forEach((e,t)=>{a[t]=e}),JSON.stringify(a)}return""}},{regex:/\{\{SESSION_ID\}\}/g,handler:()=>GS_SESSION_ID}],a=e=>{if("string"!=typeof e)return e;let t=e;for(let{regex:a,handler:l}of r)t=t.replace(a,(e,t)=>l(t));return t},l=(e,t=!1)=>{if("string"!=typeof e)return e;let r=[],a=[],l=e.replace(/```([\s\S]*?)```/gim,function(e,t){let a=t,l="",i=a.match(/^([a-zA-Z0-9_+-]+)\s*\n/);return i&&(l=i[1].toLowerCase(),a=a.substring(i[0].length)),r.push({content:a,language:l}),"CODE_BLOCK_PLACEHOLDER_"+(r.length-1)});l=(l=(l=(l=(l=(l=(l=l.replace(/`(.*?)`/gim,function(e,t){return a.push(t),"INLINE_CODE_PLACEHOLDER_"+(a.length-1)})).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")).replace(/^### (.*$)/gim,"<h3>$1</h3>")).replace(/^## (.*$)/gim,"<h2>$1</h2>")).replace(/^# (.*$)/gim,"<h1>$1</h1>")).replace(/\*\*(.*?)\*\*/gim,"<strong>$1</strong>")).replace(/\*(.*?)\*/gim,"<em>$1</em>");let i=!1,n="",s=l.split("\n");for(let o=0;o<s.length;o++){let c=s[o].match(/^\s*[\*\-] (.*)/),d=s[o].match(/^\s*(\d+)\. (.*)/);c?i&&"ul"===n?s[o]="<li>"+c[1]+"</li>":(i?s[o]="</"+n+"><ul><li>"+c[1]+"</li>":s[o]="<ul><li>"+c[1]+"</li>",i=!0,n="ul"):d?i&&"ul"===n?s[o]="<li>"+d[2]+"</li>":(i?s[o]="</"+n+"><ul><li>"+d[2]+"</li>":s[o]="<ul><li>"+d[2]+"</li>",i=!0,n="ul"):i&&""===s[o].trim()?(s[o]="</"+n+">",i=!1):i&&""!==s[o].trim()&&(s[o-1]=s[o-1].replace(/<\/li>$/," "+s[o]+"</li>"),s[o]="")}return i&&s.push("</"+n+">"),l=(l=s.join("\n")).replace(/\[(.*?)\]\((.*?)\)/gim,'<a href="$2">$1</a>'),t||(l=l.replace(/^(?!\s*<\/?(?:ul|ol|li|h\d|blockquote|pre|img|code))[^\n<]+(?:\n(?!\s*<\/?(?:ul|ol|li|h\d|blockquote|pre|img|code))[^\n<]+)*/gim,function(e){return""===e.trim()?"":"<p>"+e+"</p>"})),l=(l=(l=(l=(l=(l=(l=l.replace(/\n(?!\s*<\/?(?:p|ul|ol|li|h\d|blockquote|pre|code))/gim,"<br>")).replace(/<p>\s*<\/p>/gim,"")).replace(/CODE_BLOCK_PLACEHOLDER_(\d+)/g,function(e,t){let a=r[parseInt(t)],l=a.content,i=a.language;return(l=l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),i)?'<div class="code_language">'+i+"</div><pre><code>"+l+"</code></pre>":"<pre><code>"+l+"</code></pre>"})).replace(/INLINE_CODE_PLACEHOLDER_(\d+)/g,function(e,t){let r=a[parseInt(t)];return"<code>"+(r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"))+"</code>"})).replace(/(<br>\s*)+/g,"<br>")).replace(/^\s*<br>/g,"")).replace(/<br>\s*$/g,"")},{result_selector:i,result_handle:n="replace",loader_selector:s,apiHeaders:o,apiUrl:c,apiMethod:d,apiBody:u,responseField:p,appendField:g,assistantField:f,user_message:h,assistant_message:m,custom_response:L,responseMaps:b,response_selector:S,repeatable:A,stream_chat:v=!1,stream_response:E=!1,no_data_text:y="No data found"}=e,_=Array.isArray(o)?o.reduce((e,t)=>(t.name&&(e[t.name]=a(t.value)),e),{}):{},$=s?document.querySelector(s):null;$&&$.classList.add("active");let T=i?document.querySelector(i):null;T&&(T.classList.remove("loaded"),T.classList.remove("active"),T.classList.add("loading"));let w="gspb-api-saved-var";p&&(w=p.replace(/[^a-zA-Z0-9]/g,""));let O=(e,r,a)=>{if(r&&e){let l=JSON.parse(e),i=t(l,r);i&&(Array.isArray(i)?i.push(a):l[r]=a),e=JSON.stringify(l)}return e},q=u?a(u):null;v&&void 0!==window[w]&&(q=window[w]);let H=h?a(h):null;H&&(q=O(q,g,JSON.parse(a(H)))),fetch(a(c),{method:d||"GET",headers:_,body:q}).then(e=>{if(E){if(!e.ok)throw Error(`HTTP error! Status: ${e.status}`);if(!e.body)throw Error("ReadableStream not supported in this browser.");let r=e.body.getReader(),a="",i=new TextDecoder,s=null;T&&("replace"===n&&(T.innerHTML=""),(s=document.createElement("div")).classList.add("gs-streaming-content"),"append"===n?T.appendChild(s):"prepend"===n?T.insertBefore(s,T.firstChild):T.appendChild(s));let o="",c=()=>r.read().then(({done:e,value:r})=>{if(e){s&&!s.classList.contains("result-loaded")&&s.classList.add("result-loaded");return}let l=i.decode(r,{stream:!0});a+=l;let n;if(L&&b&&S&&!s.hasAttribute("data-initialized")){let u=document.querySelector(S);u&&(s.innerHTML=u.innerHTML,s.setAttribute("data-initialized","true"))}let g=!s.hasAttribute("data-received-first-chunk");for(;-1!==(n=a.indexOf("\n"));){let h=a.slice(0,n).trim();if(a=a.slice(n+1),h&&s)try{if("data: [DONE]"===h){console.log("Stream completed"),s.classList.add("result-loaded");continue}let A=h.startsWith("data: ")?h.substring(6):h,v=JSON.parse(A),E=p?t(v,p):v;if(g&&$&&($.classList.remove("active"),s.setAttribute("data-received-first-chunk","true"),g=!1),L&&b&&S){if(d(E),f&&m){let y=t(E,f);y&&(o+=y)}}else"string"==typeof E?(E=E.replace(/<\/?p>/g,""),s.innerHTML+=E):null!=E&&(s.innerHTML+=String(E)),s.classList.remove("loading"),s.classList.add("loaded"),s.classList.add("active"),m&&(o+=E)}catch(_){console.error("Error parsing stream chunk:",_)}}return c()}),d=e=>{if(!L||!b||!S)return e;let r={};return b.forEach(a=>{let i=a.name,n=t(e,a.value);r[i]||(r[i]=s.querySelector(i));let o=r[i];if(o.classList.add("loading"),void 0!==n&&o){if("date"===a.format&&(n=new Date(n).toLocaleString()),"markdown"===a.format&&"string"==typeof n){o.hasAttribute("data-raw-content")||o.setAttribute("data-raw-content","");let c=o.getAttribute("data-raw-content");c+=n,o.setAttribute("data-raw-content",c),o.innerHTML=l(c,!0)}else o.hasAttribute("src")?o.setAttribute("src",n):o.hasAttribute("href")?o.setAttribute("href",n):("string"==typeof n&&(n=n.replace(/<\/?p>/g,"")),o.innerHTML+=n);o.classList.remove("loading"),o.classList.add("loaded"),o.classList.add("active")}}),null};return c().catch(e=>{throw console.error("Stream error:",e),e}).finally(()=>{if(T){T.classList.remove("loading"),setTimeout(()=>{T.classList.add("loaded"),T.classList.add("active")},50);let e=T.getAttribute("data-nextrun");if(e){let t=parseInt(e);T.setAttribute("data-nextrun",t+1)}else T.setAttribute("data-nextrun",2);s&&b&&b.forEach(e=>{if("markdown"===e.format){let t=s.querySelector(e.name);if(t&&t.hasAttribute("data-raw-content")){let r=t.getAttribute("data-raw-content");t.innerHTML=l(r,!0),t.removeAttribute("data-raw-content")}}})}if(q&&g&&o&&f&&m){let r=JSON.parse(m.replace("{{RESPONSE}}",o));q=O(q,g,r),window[w]=q}if(T){let a=T.querySelectorAll("[data-gspbactions]");a.length>0&&"function"==typeof GSPB_Trigger_Actions&&GSPB_Trigger_Actions("front",a),"undefined"!=typeof GSChartRun&&GSChartRun(T),document.dispatchEvent(new CustomEvent("GSPB_API_RESPONSE",{detail:{resultElem:T,responseData:null}}))}})}return e.json()}).then(e=>{if(E)return;let r=p?t(e,p):e,a=r;if(f&&r&&q&&g&&m){let i=t(r,f),s=JSON.parse(m.replace("{{RESPONSE}}",i));q=O(q,g,s),window[w]=q}else window[w]=a;if(void 0===a&&(a='<div class="gspb-api-noresponse">'+y+"</div>"),L&&b&&S){let o=document.querySelector(S),c="",d=[];if(o){let u=e=>{let r=o.cloneNode(!0);return b.forEach(a=>{let i=a.name,n=r.querySelector(i);n.classList.add("loading");let s=t(e,a.value);void 0===s&&d.push(a.name),n&&("date"===a.format&&(s=new Date(s).toLocaleString()),"markdown"===a.format&&"string"==typeof s&&(s=l(s)),n.hasAttribute("src")?n.setAttribute("src",s):n.hasAttribute("href")?n.setAttribute("href",s):n.innerHTML=s,n.classList.remove("loading"),n.classList.add("loaded"),n.classList.add("active"))}),r.innerHTML};A&&Array.isArray(a)?a.forEach(e=>{c+=u(e)}):c=u(a),c&&(a=c),d.length>0&&d.length===b.length&&(a='<div class="gspb-api-noresponse">'+y+"</div>")}}if(T){"replace"===n?T.innerHTML=a:"append"===n?T.innerHTML+=a:"prepend"===n&&(T.innerHTML=a+T.innerHTML),Array.from(T.children).forEach(e=>{e.classList.contains("result-loaded")||setTimeout(()=>{e.classList.add("result-loaded")},10)});let h=T.querySelectorAll("[data-gspbactions]");h.length>0&&"function"==typeof GSPB_Trigger_Actions&&GSPB_Trigger_Actions("front",h),"undefined"!=typeof GSChartRun&&GSChartRun(T),document.dispatchEvent(new CustomEvent("GSPB_API_RESPONSE",{detail:{resultElem:T,responseData:r}}))}}).catch(e=>{console.error("Fetch error:",e)}).finally(()=>{if(!E){if($&&$.classList.remove("active"),T){T.classList.remove("loading"),setTimeout(()=>{T.classList.add("loaded"),T.classList.add("active")},50);let e=T.getAttribute("data-nextrun");if(e){let t=parseInt(e);T.setAttribute("data-nextrun",t+1)}else T.setAttribute("data-nextrun",2)}T&&T.querySelector(".gspb-api-noresponse")&&setTimeout(()=>{T.querySelector(".gspb-api-noresponse").remove()},1e3)}})}